---
version: '3'
services:
  mongo1:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    command: --replSet=${TEST_MONGODB_RS} --port=${TEST_MONGODB_PRIMARY_PORT} --shardsvr
    volumes:
    - ./docker/test/entrypoint-mongod.sh:/entrypoint.sh:ro
    - ./docker/test/mongod.key:/mongod.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/mongodb.pem:/mongod.pem:ro
  mongo2:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    command: --replSet=${TEST_MONGODB_RS} --port=${TEST_MONGODB_SECONDARY1_PORT} --shardsvr
    volumes:
    - ./docker/test/entrypoint-mongod.sh:/entrypoint.sh:ro
    - ./docker/test/mongod.key:/mongod.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/mongodb.pem:/mongod.pem:ro
  mongo3:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    command: --replSet=${TEST_MONGODB_RS} --port=${TEST_MONGODB_SECONDARY2_PORT} --shardsvr
    volumes:
    - ./docker/test/entrypoint-mongod.sh:/entrypoint.sh:ro
    - ./docker/test/mongod.key:/mongod.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/mongodb.pem:/mongod.pem:ro
  configsvr1:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    command: --replSet=${TEST_MONGODB_CONFIGSVR_RS} --port=${TEST_MONGODB_CONFIGSVR1_PORT} --configsvr
    volumes:
    - ./docker/test/entrypoint-mongod.sh:/entrypoint.sh:ro
    - ./docker/test/mongod.key:/mongod.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/mongodb.pem:/mongod.pem:ro
  mongos:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    command: --port=${TEST_MONGODB_MONGOS_PORT} --configdb=${TEST_MONGODB_CONFIGSVR_RS}/127.0.0.1:${TEST_MONGODB_CONFIGSVR1_PORT} 
    volumes:
    - ./docker/test/entrypoint-mongos.sh:/entrypoint.sh:ro
    - ./docker/test/mongod.key:/mongos.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/mongodb.pem:/mongos.pem:ro
    depends_on:
    - configsvr1
  init:
    network_mode: host
    image: percona/percona-server-mongodb:${TEST_PSMDB_VERSION}
    entrypoint: /init-cluster.sh
    volumes:
    - ./docker/test/init-cluster.sh:/init-cluster.sh:ro
    - ./docker/test/mongod.key:/mongod.key:ro
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/client.pem:/client.pem:ro
    env_file:
    - .env
    depends_on:
    - configsvr1
    - mongos
    - mongo1
    - mongo2
    - mongo3
  test:
    build:
      dockerfile: Dockerfile.test
      context: docker
      args:
      - GOLANG_DOCKERHUB_TAG=${GOLANG_DOCKERHUB_TAG}
    network_mode: host
    env_file:
    - .env
    volumes:
    - ./test-out:/tmp/out
    - ./docker/test/ssl/rootCA.crt:/rootCA.crt:ro
    - ./docker/test/ssl/client.pem:/client.pem:ro
    depends_on:
    - configsvr1
    - mongo1
    - mongo2
    - mongo3
    - init
